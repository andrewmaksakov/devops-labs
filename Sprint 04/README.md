# Sprint 04 — Диски, файловые системы, бэкапы и восстановление

**Цель:** защитить данные и уметь восстановиться

**Длительность:** 2 недели

---

## Теория

### Основные термины

| Термин | Что это | Аналогия |
|--------|--------|----------|
| Диск | Физическое устройство для хранения данных. HDD — вращающиеся пластины (медленнее, дешевле). SSD — микросхемы (быстрее, дороже) | Шкаф для хранения вещей |
| Файловая система | Способ организации данных на диске. Без неё диск — набор нулей и единиц. Создаёт структуру: файлы, папки, права. Типы: ext4 (Linux), NTFS (Windows), xfs (серверы) | Система ящиков и полок в шкафу |
| Монтирование (mount) | Подключение диска к папке. В Linux нет "диск C:", всё — одно дерево папок от `/`. Диск "прикрепляется" к папке | Вставить USB-флешку → она появляется как папка |
| fstab | Файл `/etc/fstab`. Список что монтировать автоматически при загрузке системы | Список задач на старте |
| SWAP | Раздел подкачки. Когда RAM не хватает — Linux перемещает данные из RAM на диск. Медленнее RAM, но лучше чем падение программы | Положить вещи из рук в рюкзак когда руки заняты |
| Page cache | Linux автоматически кеширует данные с диска в RAM. Первый раз — медленно (читает с диска). Второй раз — быстро (берёт из RAM). После перезагрузки кеш пустой — поэтому "вчера было быстрее" | Поставить часто нужную книгу на стол, а не лезть каждый раз на полку |

### Команды для работы с дисками

| Команда | Что делает | Флаги |
|---------|-----------|-------|
| `lsblk` | Список всех дисков и разделов: имя, размер, куда смонтирован | — |
| `df -h` | Сколько места занято и свободно на каждом смонтированном диске | `-h` = human readable (ГБ вместо байтов) |
| `du -sh <папка>` | Размер конкретной папки | `-s` = итого (не показывать подпапки), `-h` = human readable |
| `mount` | Показать что куда смонтировано | — |
| `cat /etc/fstab` | Посмотреть какие диски монтируются при загрузке | — |

**Как проверить размер бэкапов:**
```bash
ls -lh /var/backups/myapp/    # список с размерами
du -sh /var/backups/myapp/    # суммарный размер папки
```

### Команды для работы с архивами (tar)

| Команда | Что делает | Флаги |
|---------|-----------|-------|
| `tar -czf архив.tar.gz папка/` | Создать сжатый архив | `-c` create, `-z` gzip сжатие, `-f` имя файла |
| `tar -tzf архив.tar.gz` | Посмотреть содержимое архива | `-t` list (список) |
| `tar -xzf архив.tar.gz -C /куда/` | Распаковать архив | `-x` extract, `-C` куда распаковать |

### Что делают наши скрипты

| Скрипт | Что делает |
|--------|-----------|
| `backup.sh` | **Создаёт** архив конфигов. Три шага по порядку: 1) собирает существующие пути (Nginx конфиги, SSL сертификат, systemd unit/timer), 2) создаёт архив `tar -czf` с timestamp в имени (например `backup-20260217-223926.tar.gz`), 3) ротация — если бэкапов больше 7, удаляет самые старые |
| `restore.sh` | **Восстанавливает** из последнего бэкапа. Три шага по порядку: 1) распаковывает архив, 2) пересоздаёт симлинк Nginx в `sites-enabled`, 3) перезагружает конфиги (`nginx -t` + `systemctl reload nginx`) |

### Что такое симлинк и зачем restore.sh его пересоздаёт

**Симлинк (symbolic link)** — символическая ссылка. Файл который указывает на другой файл. Как ярлык в Windows.

У Nginx два места для конфигов:
- `/etc/nginx/sites-available/` — хранилище всех конфигов (тут лежат файлы)
- `/etc/nginx/sites-enabled/` — активные конфиги (тут лежат симлинки на файлы из sites-available)

```bash
ls -la /etc/nginx/sites-enabled/
# myapp -> /etc/nginx/sites-available/myapp
```

Стрелка `->` значит "это симлинк, указывает туда".

**Зачем так устроено:** конфиг хранится в `sites-available`. Чтобы включить — создаёшь симлинк в `sites-enabled`. Чтобы выключить — удаляешь симлинк. Сам файл конфига не трогаешь.

**Почему restore.sh пересоздаёт симлинк:** `tar` при распаковке восстанавливает файл в `sites-available`, но симлинк из `sites-enabled` в архиве не сохраняется. Поэтому скрипт создаёт его заново:
```bash
sudo ln -sf /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/myapp
```

**Шпаргалка одной строкой:** Nginx читает конфиги из `sites-enabled`, где лежат симлинки на файлы из `sites-available` — создал симлинк = сайт включён, удалил = выключен.

---

## Практические задания

### 1. Скрипт backup.sh

Архивирует конфиги (Nginx, systemd unit) + ротация (хранит 7 последних бэкапов).

### 2. Скрипт restore.sh

Восстанавливает конфиги из последнего бэкапа.

### 3. Учение

Удалить конфиги Nginx/юнит/данные сервиса → восстановить из бэкапа.

---

## Структура папки

```
Sprint 04/
├── README.md
├── scripts/
│   ├── backup.sh          # Архивирование + ротация
│   └── restore.sh         # Восстановление
└── troubleshooting.md     # Типовые проблемы
```

---

## Как использовать

```bash
# Создать бэкап
sudo bash scripts/backup.sh

# Посмотреть бэкапы
ls -lh /var/backups/myapp/

# Проверить содержимое бэкапа
tar -tzf /var/backups/myapp/backup-YYYYMMDD-HHMMSS.tar.gz

# Восстановить из последнего бэкапа
sudo bash scripts/restore.sh

# Восстановить из конкретного бэкапа
sudo bash scripts/restore.sh /var/backups/myapp/backup-20260217-120000.tar.gz
```

---

## Экзамен (самопроверка)

- [ ] Знаю что показывает `lsblk`, `df -h`, `du -sh`
- [ ] Могу создать бэкап и показать где он лежит
- [ ] Могу проверить размер и содержимое бэкапа
- [ ] Могу восстановить конфиги из бэкапа
- [ ] Могу объяснить что такое page cache
